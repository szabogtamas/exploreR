---
title: "Explorative stats for Clinical Chemistry parameters"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      toc_collapsed: true
---

## Setup

```{r}
# Define parameters of interest
PARAM_CODE <- c("D3")
LAB_DB_LOCATION <- "~/Datasets/LabResults/"
```

```{r}
# Import packages
library(tidyr)
library(dplyr)
library(purrr)
library(stringr)
library(readxl)
library(googledrive)
library(ggplot2)
library(ggsci)
library(ggpubr)
library(plotly)
library(DT)
```

```{r}
# Define small function summarizing median, iqr and outlier boundaries
calc_quantile_boundaries <- function(serum_level) {
  serum_level %>%
    quantile(probs=c(0.25, 0.75), na.rm=TRUE) %>%
    t() %>%
    data.frame() %>%
    `colnames<-`(c("LQ", "UQ")) %>%
    mutate(
      MEDIAN = median(serum_level, na.rm=TRUE),
      RANGE = 1.5 * (UQ - LQ),
      LB = LQ - RANGE,
      UB = UQ + RANGE
    )
}
```

```{r}
# Add some buttons to DT table
show_tab <- function(tab){
  datatable(
    tab, extensions = "Buttons",
    options = list(
      scrollX="400px",
      dom = "Bfrtip",
      buttons = list(
        list(
          extend = "collection",
          buttons = c("csv", "excel"),
          text = "Download"
        )
      )
    )
  )
}

color_names <- pal_npg()(9)
```

```{r}
# Set how Google Drive authentication should be done
drive_auth(cache = "/home/rstudio/local_files/.secrets", use_oob = TRUE)
```

```{r message = FALSE, warning = FALSE}
# Define function that opens table from drive
read_from_drive <- function(drive_path) {
  path <- drive_get(drive_path)
  drive_download(path, overwrite = TRUE)
  data_file <- basename(drive_path)
  data_table <- data_file %>%
    gzfile() %>%
    read.csv(sep="|", stringsAsFactors=FALSE, header=FALSE)
  colnames(data_table) <- c(
    "db_row", "patient_id", "gender", "age", "order_id", "date", "time", "param",
    "value_c", "value_n", "is_numeric", "needs_revision", "qc_comment", "instrument", "unit",
    "normal_range", "ward_id", "lab_comment"
  )
  data_table$file_name <- data_file
  unlink(data_file)
  return(data_table)
}

```

```{r}
# Download from drive
main_table <- PARAM_CODE %>%
  paste(LAB_DB_LOCATION, ., ".txt.gz", sep="") %>%
  map(read_from_drive) %>%
  bind_rows()
```

```{r warning=FALSE}
# Add gender information to main table and format values to numeric
main_table <- main_table %>%
  mutate(
    serum_level = as.numeric(value_n),
    gender = case_when(
      gender == "m" ~ "Male",
      gender == "f" ~ "Female",
      TRUE ~ "Unknown"
    )
  ) %>%
  add_count(gender) %>%
  mutate(
    gender = paste(gender, " (", n, ")", sep="")
  ) %>%
  select(-n)

female_label <- main_table %>%
  filter(grepl("Female", gender)) %>%
  .$gender %>%
  unique()

male_label <- main_table %>%
  filter(grepl("Male", gender)) %>%
  .$gender %>%
  unique()

other_label <- main_table %>%
  filter(grepl("Unknown", gender)) %>%
  .$gender %>%
  unique()

main_table <- main_table %>%
  mutate(
    gender = factor(gender, levels=c(female_label, male_label, other_label))
  )
```

## Basic descriptive statistics

### DB health check

```{r warning=FALSE}
tmp_table <- main_table %>%
  add_count(is_numeric) %>%
  mutate(
    is_numeric = ifelse(is_numeric == "N", "Numerical result", "Parametric or comented"),
    is_numeric = paste(is_numeric, " (", n, ")", sep="")
  )

numres_label <- tmp_table %>%
  filter(grepl("Numerical result", is_numeric)) %>%
  .$is_numeric %>%
  unique()

parres_label <- tmp_table %>%
  filter(grepl("Parametric or comented", is_numeric)) %>%
  .$is_numeric %>%
  unique()

p <- tmp_table %>%
  mutate(
    is_numeric = factor(is_numeric, levels=c(parres_label, numres_label))
  ) %>%
  ggplot(aes(x=param, fill=is_numeric)) + 
  geom_histogram(position="stack", stat="count") +
  scale_fill_npg() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle=30, vjust=0.5, hjust=1)
  ) +
  labs(title="Number of measurements per parameter code", x="", y="")

ggplotly(p)
```

### Distribution of measurements by gender




```{r warning=FALSE}
p <- main_table %>%
  ggplot(aes(x=serum_level, fill=gender)) + 
  geom_density(alpha=0.6) +
  scale_fill_npg() +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle=30, vjust=0.5, hjust=1)
  ) +
  labs(title="Distribution of measurements by gender", x="", y="")

ggplotly(p)
```

### Normal range and outliers

### Outliers based on quantiles

```{r}
median_iqr_table <- main_table %>%
  filter(is_numeric == "N") %>%
  group_by(gender) %>%
  summarize(calc_quantile_boundaries(serum_level))
         
show_tab(median_iqr_table)
```



## Change in characteristics by time

### Stability of measurement medians
